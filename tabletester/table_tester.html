<html>
<head>
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript">

        function copyTable() {
            var tableClone = $("table").clone();
            $("table").addClass("hidden");
            $("table").css("display", "none");
            tableClone.appendTo($("body"));
        }

        function insertInput() {
            var level = getDisplayLevel();
            console.log("testing level: " + getDisplayLevel());
            $("table:not(.hidden) td").each( function(index) {
                var currentLevel = readCookie("level" + index);
                if (currentLevel == null || currentLevel <= level) {
                    $(this).html('<input type="text" value="" />');
                }
            });
        }

        function addCheckButton() {
            $("input[name=practice]").remove();
            $('<input name="check" type="button" value="check" onclick="check()" />').prependTo($("body"));
        }

        function addPracticeButton() {
            $('<input name="practice" type="button" value="practice" onclick="setupPractice()" />').prependTo($("body"));
        }


        function check() {
            var correctValues = $("table.hidden td");
            $("table:not(.hidden) td").each(function(index, element) {
                var input = $("input", this);
                console.log(input.length);
                if (input.length == 1) {
                    var correctValue = $(correctValues[index]).html();
                    var value = $(input).val();
                    var correct = (correctValue === value);
                    if (correct) {
                        $(input).css("background-color", "green");
                    } else {
                        $(input).css("background-color", "red");
                        $('<span>' + correctValue + '</span>').appendTo($(this));
                    }
                    updateHistory(index, correct);
                }
            });
        }

        function createCookie(name, value, hours) {
            var expires;

            var date = new Date();
            if (hours) {
                date.setTime(date.getTime() + (hours * 60 * 60 * 1000));
                expires = "; expires=" + date.toGMTString();
            } else {
                expires = "";
            }
            document.cookie = encodeURIComponent(name) + "=" + encodeURIComponent(value) + expires + "; path=/";
        }

        function getTime() {
            return new Date().getTime();
        }

        /*
        This function will check the saved last testing time and comapare it to the current
        time to figure out up to which level we are testing.
         */
        function getDisplayLevel() {
            var last = readCookie("last");
            if (last == null) {
                last = getTime();
            }
            console.log("last: " + last);
            var current = getTime();
            console.log("current: " + current);
            var timeInterval = current - last;
            console.log("time interval: " + timeInterval);
            var hourInterval = timeInterval / (60 * 60 * 1000);
            console.log("hour interval: " + hourInterval);
            var level = Math.floor(Math.sqrt(hourInterval));
            return level;
        }

        function readCookie(name) {
            var nameEQ = encodeURIComponent(name) + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
            }
            return null;
        }

        function eraseCookie(name) {
            createCookie(name, "", -1);
        }

        function updateHistory(index, correct) {
            var name = "level" + index;
            var level = readCookie(name);
            if (level == null) {
                level = 0;
            }
            if (correct) {
                level = level + 1;
            } else {
                if (level > 0) {
                    level = level - 1;
                }
            }
            createCookie(name, level, 150*24);
        }

        function updateLastTested() {
            createCookie("last", getTime(), 150*24);
        }

        function setupPractice() {
            copyTable();
            addCheckButton();
            insertInput();
        }

        $(document).ready(function() {
            addPracticeButton();
        });
    </script>
</head>
<body>
<table class="scope-swap center middle">
    <thead>
    <tr>
        <th colspan="2"></th>
        <th>ich</th>
        <th>du</th>
        <th>er</th>
        <th>sie</th>
        <th>es</th>
        <th>wir</th>
        <th>ihr</th>
        <th>sie</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <th rowspan="2"><strong>nominative</strong></th>
        <th>m/n</th>
        <td>mein</td>
        <td>dein</td>
        <td>sein</td>
        <td>ihr</td>
        <td>sein</td>
        <td>unser</td>
        <td>euer</td>
        <td>ihr</td>
    </tr>
    <tr>
        <th>f/pl</th>
        <td>meine</td>
        <td>deine</td>
        <td>seine</td>
        <td>ihre</td>
        <td>seine</td>
        <td>unsere</td>
        <td>eure</td>
        <td>ihre</td>
    </tr>
    <tr>
        <th rowspan="2"><strong>genitive</strong></th>
        <th>m/n</th>
        <td>meines</td>
        <td>deines</td>
        <td>seines</td>
        <td>ihres</td>
        <td>seines</td>
        <td>unseres</td>
        <td>eures</td>
        <td>ihres</td>
    </tr>
    <tr>
        <th>f/pl</th>
        <td>meiner</td>
        <td>deiner</td>
        <td>seiner</td>
        <td>ihrer</td>
        <td>seiner</td>
        <td>unserer</td>
        <td>eurer</td>
        <td>ihrer</td>
    </tr>
    <tr>
        <th rowspan="3"><strong>dative</strong></th>
        <th>m/n</th>
        <td>meinem</td>
        <td>deinem</td>
        <td>seinem</td>
        <td>ihrem</td>
        <td>seinem</td>
        <td>unserem</td>
        <td>eurem</td>
        <td>ihrem</td>
    </tr>
    <tr>
        <th>f</th>
        <td>meiner</td>
        <td>deiner</td>
        <td>seiner</td>
        <td>ihrer</td>
        <td>seiner</td>
        <td>unserer</td>
        <td>eurer</td>
        <td>ihrer</td>
    </tr>
    <tr>
        <th>pl</th>
        <td>meinen</td>
        <td>deinen</td>
        <td>seinen</td>
        <td>ihren</td>
        <td>seinen</td>
        <td>unseren</td>
        <td>euren</td>
        <td>ihren</td>
    </tr>
    <tr>
        <th rowspan="3"><strong>accusative</strong></th>
        <th>m</th>
        <td>meinen</td>
        <td>deinen</td>
        <td>seinen</td>
        <td>ihren</td>
        <td>seinen</td>
        <td>unseren</td>
        <td>euren</td>
        <td>ihren</td>
    </tr>
    <tr>
        <th>n</th>
        <td>mein</td>
        <td>dein</td>
        <td>sein</td>
        <td>ihr</td>
        <td>sein</td>
        <td>unser</td>
        <td>euer</td>
        <td>ihr</td>
    </tr>
    <tr>
        <th>f/pl</th>
        <td>meine</td>
        <td>deine</td>
        <td>seine</td>
        <td>ihre</td>
        <td>seine</td>
        <td>unsere</td>
        <td>eure</td>
        <td>ihre</td>
    </tr>
    </tbody>
</table>
</body>
</html>