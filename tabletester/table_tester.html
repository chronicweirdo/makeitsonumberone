<html>
<head>
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jquery.cookie.js"></script>
    <script type="text/javascript">

        var SUFFIX = window.location.pathname.substr(window.location.pathname.lastIndexOf('/')+1);
        var NAME_LAST = "last_" + SUFFIX;
        var NAME_LEVELS = "levels_" + SUFFIX;

        function copyTable() {
            var tableClone = $("table").clone();
            $("table").addClass("hidden");
            $("table").css("display", "none");
            tableClone.appendTo($("body"));
        }

        function insertInput() {
            var level = getDisplayLevel();
            console.log("testing level: " + getDisplayLevel());
            var levels = readCookie(NAME_LEVELS);
            if (levels == null) {
                levels = [];
            }
            console.log("levels:");
            console.log(levels);
            $("table:not(.hidden) td").each( function(index) {
                var currentLevel = levels[index];
                if (currentLevel == null || currentLevel <= level) {
                    $(this).html('<input type="text" value="" />');
                }
            });
        }

        function addCheckButton() {
            $("input[name=practice]").remove();
            $('<input name="check" type="button" value="check" onclick="check()" />').prependTo($("body"));
        }

        function addPracticeButton() {
            $('<input name="practice" type="button" value="practice" onclick="setupPractice()" />').prependTo($("body"));
        }


        function check() {
            var score = 0;
            var correctValues = $("table.hidden td");
            var levels = readCookie(NAME_LEVELS);
            console.log("levels:");
            console.log(levels);
            if (levels == null) {
                levels = [];
            }
            $("table:not(.hidden) td").each(function(index, element) {
                var input = $("input", this);
                if (input.length == 1) {
                    var correctValue = $(correctValues[index]).html();
                    var value = $(input).val();
                    var correct = (correctValue === value);
                    if (correct) {
                        $(input).css("background-color", "green");
                        score = score + 1;
                    } else {
                        $(input).css("background-color", "red");
                        $('<span>' + correctValue + '</span>').appendTo($(this));
                    }

                    var level = levels[index];
                    if (level == null) {
                        level = 0;
                    }
                    if (correct) {
                        level = level + 1;
                    } else {
                        if (level > 0) {
                            level = level - 1;
                        }
                    }
                    levels[index] = level;
                }
            });
            createCookie(NAME_LEVELS, levels);
            var finalScore = (score / correctValues.length) * 100;
            $("input[name=check]").remove();
            $('<input name="reload" type="button" value="reload" onclick="location.reload()" />').prependTo($("body"));
            $('<span>score:' + finalScore + '%</span>').prependTo($("body"));

        }

        function createCookie(name, value) {
            $.cookie(name, value, { expires: 365 });
        }

        function getTime() {
            return new Date().getTime();
        }

        /*
        This function will check the saved last testing time and comapare it to the current
        time to figure out up to which level we are testing.
         */
        function getDisplayLevel() {
            var last = readCookie(NAME_LAST);
            if (last == null) {
                last = getTime();
            }
            var current = getTime();
            var timeInterval = current - last;
            var hourInterval = timeInterval / (60 * 60 * 1000);
            var level = Math.floor(Math.sqrt(hourInterval));
            return level;
        }

        function readCookie(name) {
            var value = $.cookie(name);
            if (value == undefined) {
                return null;
            }
            return value;
        }


        function updateHistory(index, correct) {
            var name = document.location + index;
            var level = readCookie(name);
            if (level == null) {
                level = 0;
            }
            if (correct) {
                level = level + 1;
            } else {
                if (level > 0) {
                    level = level - 1;
                }
            }
            createCookie(name, level);
        }

        function updateLastTested() {
            createCookie(NAME_LAST, getTime());
        }

        function setupPractice() {
            copyTable();
            addCheckButton();
            insertInput();
        }

        $(document).ready(function() {
            console.log(window.location.pathname);
            console.log(SUFFIX);
            console.log(window.location);
            console.log(NAME_LAST);
            console.log(NAME_LEVELS);

            $.cookie.json = true;
            $.cookie.path = window.location.pathname;
            addPracticeButton();
        });
    </script>
</head>
<body>
<table class="scope-swap center middle">
    <thead>
    <tr>
        <th colspan="2"></th>
        <th>ich</th>
        <th>du</th>
        <th>er</th>
        <th>sie</th>
        <th>es</th>
        <th>wir</th>
        <th>ihr</th>
        <th>sie</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <th rowspan="2"><strong>nominative</strong></th>
        <th>m/n</th>
        <td>mein</td>
        <td>dein</td>
        <td>sein</td>
        <td>ihr</td>
        <td>sein</td>
        <td>unser</td>
        <td>euer</td>
        <td>ihr</td>
    </tr>
    <tr>
        <th>f/pl</th>
        <td>meine</td>
        <td>deine</td>
        <td>seine</td>
        <td>ihre</td>
        <td>seine</td>
        <td>unsere</td>
        <td>eure</td>
        <td>ihre</td>
    </tr>
    <tr>
        <th rowspan="2"><strong>genitive</strong></th>
        <th>m/n</th>
        <td>meines</td>
        <td>deines</td>
        <td>seines</td>
        <td>ihres</td>
        <td>seines</td>
        <td>unseres</td>
        <td>eures</td>
        <td>ihres</td>
    </tr>
    <tr>
        <th>f/pl</th>
        <td>meiner</td>
        <td>deiner</td>
        <td>seiner</td>
        <td>ihrer</td>
        <td>seiner</td>
        <td>unserer</td>
        <td>eurer</td>
        <td>ihrer</td>
    </tr>
    <tr>
        <th rowspan="3"><strong>dative</strong></th>
        <th>m/n</th>
        <td>meinem</td>
        <td>deinem</td>
        <td>seinem</td>
        <td>ihrem</td>
        <td>seinem</td>
        <td>unserem</td>
        <td>eurem</td>
        <td>ihrem</td>
    </tr>
    <tr>
        <th>f</th>
        <td>meiner</td>
        <td>deiner</td>
        <td>seiner</td>
        <td>ihrer</td>
        <td>seiner</td>
        <td>unserer</td>
        <td>eurer</td>
        <td>ihrer</td>
    </tr>
    <tr>
        <th>pl</th>
        <td>meinen</td>
        <td>deinen</td>
        <td>seinen</td>
        <td>ihren</td>
        <td>seinen</td>
        <td>unseren</td>
        <td>euren</td>
        <td>ihren</td>
    </tr>
    <tr>
        <th rowspan="3"><strong>accusative</strong></th>
        <th>m</th>
        <td>meinen</td>
        <td>deinen</td>
        <td>seinen</td>
        <td>ihren</td>
        <td>seinen</td>
        <td>unseren</td>
        <td>euren</td>
        <td>ihren</td>
    </tr>
    <tr>
        <th>n</th>
        <td>mein</td>
        <td>dein</td>
        <td>sein</td>
        <td>ihr</td>
        <td>sein</td>
        <td>unser</td>
        <td>euer</td>
        <td>ihr</td>
    </tr>
    <tr>
        <th>f/pl</th>
        <td>meine</td>
        <td>deine</td>
        <td>seine</td>
        <td>ihre</td>
        <td>seine</td>
        <td>unsere</td>
        <td>eure</td>
        <td>ihre</td>
    </tr>
    </tbody>
</table>
</body>
</html>