<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Testing what I can do with the mouse coordonates and javascript</title>
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript">
        /*
        We have a selection starting from one node and ending in another node.
        We want to delete text from the start position in the start node to the end of the start node.
        We want to delete text from the start of the end node to the end position inside the end node.
        We want to delete all nodes in between - all nodes that are part of the selection.

        To decide which nodes are part of the selection, we must create a postorder traversal of the page.
        Take the nodes between the start node and the end node in this postorder traversal.
        Delete nodes one by one. Delete a node if it does not have children left outside the selected section
        of the postorder traversal.

        Methods:
            postorder(startNode, endNode)

         */
        var selection = window.getSelection();

        $(document).ready(function() {
            initKeypressListener();
        });

        function initKeypressListener() {
            $("body").keypress(doOnKeypress);
            //$("body").click(doOnKeypress);
            $("body").mouseup(doOnMouseUp);
        }

        function doOnKeypress(event) {
            if (event.which == 8) {
                deleteText(selection.anchorNode, selection.anchorOffset, selection.focusNode, selection.focusOffset);
            }
        }

        function deleteNodes(nodes) {
            for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].childNodes.length == 0) {
                    nodes[i].remove();
                }
            }
        }

        function postorder(startNode, endNode) {
            var caret = startNode;
            var traversal = [];
            while (caret != endNode) {
                // put node in traversal
                traversal.push(caret);
                // move to next node in order
                caret = nextNode(caret);
            }
            return traversal;
        }

        function nextNode(node) {
            if (node.nextSibling == null) {
                // if node is the last sibling in the parent node, the next node is the parent
                return node.parentNode;
            } else {
                // otherwise, the next node is the leftmost leaf of the next sibling
                var leaf = node.nextSibling;
                while (leaf.firstChild != null) {
                    leaf = leaf.firstChild;
                }
                return leaf;
            }
        }

        function doOnMouseUp(event) {
            selection = window.getSelection();
            console.log(selection);
        }

        function deleteText(startNode, startIndex, endNode, endIndex) {
            var traversal = postorder(startNode, endNode);
            console.log(traversal);
            var toDelete = traversal.slice(1, traversal.length - 1);
            console.log(toDelete);
            deleteNodes(toDelete);
            // delete text in first and last node
            var startNodeRemainingText = startNode.textContent.substring(
                    0,
                    startIndex
            );
            console.log(startNodeRemainingText);
            startNode.textContent = startNodeRemainingText;
            var endNodeRemainingText = endNode.textContent.substring(
                    endIndex,
                    endNode.textContent.length
            );
            console.log(endNodeRemainingText);
            endNode.textContent = endNodeRemainingText;
        }
    </script>
</head>
<body>

<p>Unu doi trei patru <b>cinci</b> sase sapte <span>opt noua</span></p>
<p>Zece unsprazece douasprazece:
<ul>
    <li>treisprazece</li>
    <li>paisprazece cincisprazece</li>
    <li><span>saisprazece</span> saptesprazece</li>
    <li><a href="google.com">optsprazece</a></li>
</ul>
</p>
</body>
</html>